<%@page import="com.hms.entity.Doctor"%>
<%@page import="java.util.List"%>
<%@page import="com.hms.db.DBConnection"%>
<%@page import="com.hms.dao.DoctorDAO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@page isELIgnored="false"%>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Book Appointment | Doctor Patient Portal</title>
<%@include file="component/allcss.jsp"%>

<style>
/* ===== Reset and Base ===== */
body {
	margin: 0;
	padding: 0;
	font-family: "Poppins", sans-serif;
	background: linear-gradient(135deg, #cce5ff 0%, #e6f0ff 100%);
	min-height: 100vh;
	display: flex;
	flex-direction: column;
}

/* ===== Background ===== */
.appointment-section {
	position: relative;
	width: 100%;
	min-height: 100vh;
	background: url('img/hospital1.jpg') center/cover no-repeat;
	display: flex;
	align-items: center;
	justify-content: center;
	padding: 2rem;
}

.appointment-section::before {
	content: "";
	position: absolute;
	inset: 0;
	background: rgba(0, 50, 150, 0.4);
	backdrop-filter: blur(12px);
	-webkit-backdrop-filter: blur(12px);
}

/* ===== Glass Card ===== */
.glass-form {
	position: relative;
	z-index: 2;
	width: 95%;
	max-width: 880px;
	background: rgba(255, 255, 255, 0.15);
	border: 1px solid rgba(255, 255, 255, 0.3);
	backdrop-filter: blur(20px);
	-webkit-backdrop-filter: blur(20px);
	border-radius: 1.5rem;
	padding: 2.5rem 3rem;
	box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
	color: #fff;
}

/* ===== Title ===== */
.page-title {
	text-align: center;
	margin-bottom: 2rem;
	color: #fff;
}
.page-title h2 {
	font-size: 2.2rem;
	font-weight: 700;
	display: inline-flex;
	align-items: center;
	gap: 12px;
}
.page-title i {
	font-size: 1.8rem;
	color: #00c6ff;
}

/* ===== Form ===== */
.form-label {
	font-weight: 600;
	color: #ffffff;
	margin-bottom: 0.3rem;
}

.form-control,
.form-select,
textarea {
	background: rgba(255, 255, 255, 0.15);
	border: 1px solid rgba(255, 255, 255, 0.3);
	color: #fff;
	border-radius: 0.8rem;
	padding: 0.7rem 1rem;
	transition: all 0.3s ease;
}

.form-control::placeholder {
	color: #e5e5e5;
}

.form-control:focus,
.form-select:focus,
textarea:focus {
	background: rgba(255, 255, 255, 0.25);
	border-color: #00c6ff;
	box-shadow: 0 0 0 3px rgba(0, 198, 255, 0.3);
	color: #fff;
}

/* ===== Error Message ===== */
.text-danger {
	font-size: 0.9rem;
	color: #ff6666 !important;
}

/* ===== Buttons ===== */
.btn.my-bg-color {
	background: linear-gradient(135deg, #007bff, #00bfff);
	border: none;
	border-radius: 0.8rem;
	font-weight: 600;
	padding: 0.8rem 1rem;
	transition: all 0.3s ease;
}

.btn.my-bg-color:hover {
	background: linear-gradient(135deg, #005ce6, #0099cc);
	transform: translateY(-2px);
	box-shadow: 0 5px 20px rgba(0, 191, 255, 0.4);
}

/* ===== Success / Error Message ===== */
.alert {
	border-radius: 0.6rem;
	font-weight: 500;
	margin-bottom: 1rem;
}

/* ===== Responsive ===== */
@media (max-width: 768px) {
	.glass-form {
		padding: 1.5rem;
	}
	.page-title h2 {
		font-size: 1.6rem;
	}
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
	const today = new Date().toISOString().split('T')[0];
	const apptEl = document.getElementById("appointmentDate");
	if (apptEl) apptEl.setAttribute('min', today);

	// Email Validation
	const emailInput = document.getElementById("email");
	const emailError = document.getElementById("emailError");
	const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

	function validateEmail() {
		const value = emailInput.value.trim();
		emailError.textContent = "";
		emailInput.classList.remove("is-invalid", "is-valid");

		if (value === "") {
			emailError.textContent = "Email is required.";
			emailInput.classList.add("is-invalid");
			return false;
		}
		if (!emailPattern.test(value)) {
			emailError.textContent = "Please enter a valid email (e.g., user@example.com)";
			emailInput.classList.add("is-invalid");
			return false;
		}
		emailInput.classList.add("is-valid");
		return true;
	}

	if (emailInput) emailInput.addEventListener("input", validateEmail);
	const form = document.querySelector("form");
	if (form) {
		form.addEventListener("submit", function(e) {
			if (!validateEmail()) {
				e.preventDefault();
				emailInput.focus();
			}
		});
	}
});
</script>
</head>

<body>
	<%@include file="component/navbar.jsp"%>

	<section class="appointment-section">
		<div class="page-title">
			<h2><i class="fa fa-calendar-check-o"></i> Book Your Appointment</h2>
		</div>

		<div class="glass-form">
			<!-- ===== Alerts ===== -->
			<c:if test="${not empty successMsg}">
				<div class="alert alert-success text-center">${successMsg}</div>
				<c:remove var="successMsg" scope="session" />
			</c:if>
			<c:if test="${not empty errorMsg}">
				<div class="alert alert-danger text-center">${errorMsg}</div>
				<c:remove var="errorMsg" scope="session" />
			</c:if>

			<form class="row g-3" action="addAppointment" method="post">
				<input type="hidden" name="userId" value="${userObj.id}">

				<div class="col-md-6">
					<label class="form-label">Full Name</label>
					<input required name="fullName" type="text" placeholder="Enter full name"
						class="form-control" pattern="^[A-Za-z\\s]{2,40}$" maxlength="40"
						oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')"
						title="2-40 letters only, no numbers/symbols">
				</div>

				<div class="col-md-6">
					<label class="form-label">Gender</label>
					<select class="form-select" name="gender" required>
						<option selected disabled value="">Select Gender</option>
						<option value="male">Male</option>
						<option value="female">Female</option>
					</select>
				</div>

				<div class="col-md-6">
					<label class="form-label">Age</label>
					<input name="age" required type="number" placeholder="Enter your age"
						class="form-control" min="1" max="115"
						oninput="if(this.value < 1) this.value='';"
						title="Valid age: 1 to 115">
				</div>

				<div class="col-md-6">
					<label class="form-label">Appointment Date</label>
					<input required name="appointmentDate" type="date"
						class="form-control" id="appointmentDate">
				</div>

				<div class="col-md-6">
					<label class="form-label">Email</label>
					<input required id="email" name="email" type="email" placeholder="Enter your email"
						class="form-control" maxlength="75">
					<div id="emailError" class="mt-1 text-danger"></div>
				</div>

				<div class="col-md-6">
					<label class="form-label">Phone</label>
					<input name="phone" required type="tel" placeholder="Enter 10-digit number"
						class="form-control" pattern="^[0-9]{10}$" maxlength="10"
						oninput="this.value = this.value.replace(/[^0-9]/g, '');"
						title="Enter valid 10-digit phone number (e.g., 9876543210)">
				</div>

				<div class="col-md-6">
					<label class="form-label">Diseases</label>
					<input required name="diseases" type="text" placeholder="Enter diseases"
						class="form-control">
				</div>

				<div class="col-md-6">
					<label class="form-label">Doctor</label>
					<select required class="form-select" name="doctorNameSelect">
						<option selected disabled value="">Select Doctor</option>
						<%
							DoctorDAO doctorDAO = new DoctorDAO(DBConnection.getConn());
							List<Doctor> listOfDoctor = doctorDAO.getAllDoctor();
							for (Doctor d : listOfDoctor) {
						%>
						<option value="<%=d.getId()%>"><%=d.getFullName()%> (<%=d.getSpecialist()%>)</option>
						<%
							}
						%>
					</select>
				</div>

				<div class="col-12">
					<label class="form-label">Full Address</label>
					<textarea name="address" required class="form-control" rows="3"
						placeholder="Enter full address"></textarea>
				</div>

				<!-- Submit / Login Buttons -->
				<c:if test="${empty userObj}">
					<div class="col-12 mt-3">
						<a href="user_login.jsp" class="btn my-bg-color text-white w-100 py-2">
							Login to Book Appointment
						</a>
					</div>
				</c:if>

				<c:if test="${not empty userObj}">
					<div class="col-12 mt-3">
						<button type="submit" class="btn my-bg-color text-white w-100 py-2">
							Submit Appointment
						</button>
					</div>
				</c:if>
			</form>
		</div>
	</section>

	<%@include file="component/footer.jsp"%>
</body>
</html>
