<%@page import="com.hms.entity.Doctor"%>
<%@page import="com.hms.dao.DoctorDAO"%>
<%@page import="com.hms.entity.User"%>
<%@page import="com.hms.entity.Appointment"%>
<%@page import="java.util.List"%>
<%@page import="com.hms.db.DBConnection"%>
<%@page import="com.hms.dao.AppointmentDAO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@page isELIgnored="false"%>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>My Appointments</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <%@include file="component/allcss.jsp"%>

    <style>
        /* Custom Styles for the Blurred Background and Central Card */
        :root {
            --primary-blue: #007bff; /* Standard Bootstrap Blue */
            --light-blue: #007bff; /* Using primary color for titles */
        }
        
        body {
            /* Setting up body for the pseudo-element background */
            min-height: 100vh;
            margin: 0;
            padding: 0;
            position: relative;
            overflow-x: hidden; /* Prevent horizontal scroll on mobile */
            background-color: #f8f9fa; /* Fallback/Base color */
        }

        /* --- BLURRED BACKGROUND PSEUDO-ELEMENT --- */
        body::before {
            content: "";
            position: fixed; /* Fixed position so it stays put while content scrolls */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Using a light, generic medical office background. Use a real path if available. */
            background-image: url('https://placehold.co/1920x1080/E0F7FA/29B6F6?text=Medical+Office+Background');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            filter: grayscale(10%) blur(5px); /* Apply blur only here */
            z-index: -1; /* Place behind the content */
        }
        
        /* Overlay container to hold the sharp, main content */
        .content-overlay {
            position: relative; /* Ensures it sits above z-index: -1 */
            z-index: 10;
            width: 100%;
            padding-top: 56px; /* Space for fixed navbar */
        }
        
        .appointment-card {
            background-color: rgba(255, 255, 255, 0.95); /* Slightly transparent white card */
            border-radius: 1.5rem; /* Larger rounded corners */
            box-shadow: 0 1rem 3rem rgba(0, 0, 0, 0.175); /* Elevated shadow */
            padding: 2rem;
            margin: 2rem auto;
        }

        .card-header-text {
            color: var(--light-blue);
            font-weight: 700;
        }
        
        .table thead th {
            background-color: var(--primary-blue);
            color: white;
            white-space: nowrap; /* Prevents column headers from wrapping too much */
        }
        
        .table-responsive {
            border: 1px solid #ddd;
            border-radius: 0.5rem;
            overflow-x: auto;
        }
        
        /* Responsive adjustments for mobile view */
        @media (max-width: 768px) {
            .appointment-card {
                padding: 1rem;
                margin: 1rem 0.5rem;
            }
        }
    </style>
</head>
<body>
    
    <!-- Navbar (Will sit on top of the blurred body) -->
    <%@include file="component/navbar.jsp"%>

    <!-- Redirect if not logged in -->
    <c:if test="${empty userObj }">
        <c:redirect url="/user_login.jsp"></c:redirect>
    </c:if>

    <!-- Content Overlay Container -->
    <div class="content-overlay">
        
        <!-- Page Title -->
        <div class="container-fluid pt-4 text-center">
            <h1 class="text-white" style="text-shadow: 1px 1px 5px rgba(0,0,0,0.5);">My Appointments</h1>
        </div>

        <!-- Appointment List -->
        <div class="container p-2">
            <div class="row">
                <!-- Centered Card: Using col-lg-10 and mx-auto for responsiveness -->
                <div class="col-12 col-lg-10 mx-auto">
                    <div class="appointment-card">
                        <h3 class="fw-bold text-center card-header-text fs-4 mb-4">
                            Your Appointment History
                        </h3>
                        
                        <div class="table-responsive">
                            <table class="table table-striped table-hover align-middle">
                                <thead>
                                    <tr>
                                        <th scope="col">Full Name</th>
                                        <th scope="col">Gender</th>
                                        <th scope="col">Age</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Phone</th>
                                        <th scope="col">Diseases</th>
                                        <th scope="col">Doctor</th>
                                        <th scope="col">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <%
                                        User user = (User) session.getAttribute("userObj");
                                        // --- START: Backend Logic (DO NOT MODIFY) ---
                                        DoctorDAO dDAO = new DoctorDAO(DBConnection.getConn());
                                        AppointmentDAO appDAO = new AppointmentDAO(DBConnection.getConn());
                                        
                                        List<Appointment> list = appDAO.getAllAppointmentByLoginUser(user.getId());
                                        for (Appointment apptList : list) {
                                            Doctor doctor = dDAO.getDoctorById(apptList.getDoctorId());
                                        // --- END: Backend Logic ---
                                    %>
                                    <tr>
                                        <td><%=apptList.getFullName()%></td>
                                        <td><%=apptList.getGender()%></td>
                                        <td><%=apptList.getAge()%></td>
                                        <td><%=apptList.getAppointmentDate()%></td>
                                        <td><%=apptList.getPhone()%></td>
                                        <td><%=apptList.getDiseases()%></td>
                                        <td><%=doctor.getFullName()%></td>
                                        <td>
                                            <%
                                                if ("Pending".equals(apptList.getStatus())) {
                                            %> 
                                            <span class="badge bg-warning text-dark p-2 fw-normal rounded-pill">Pending</span> 
                                            <%
                                                } else {
                                            %> 
                                            <span class="badge bg-success p-2 fw-normal rounded-pill"><%=apptList.getStatus()%></span> 
                                            <%
                                                }
                                            %>
                                        </td>
                                    </tr>
                                    <%
                                        }
                                    %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>