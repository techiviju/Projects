<%@page import="com.hms.entity.Specialist"%>
<%@page import="java.util.List"%>
<%@page import="com.hms.db.DBConnection"%>
<%@page import="com.hms.dao.SpecialistDAO"%>
<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="jakarta.tags.core"%>
<%@page isELIgnored="false"%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Edit Profile | Doctor</title>
<%@include file="../component/allcss.jsp"%>

<script>
function validateDOB() {
  const dobInput = document.getElementById("dateOfBirth");
  const dobError = document.getElementById("dobError");
  const dobValue = dobInput.value;

  dobError.textContent = "";
  dobInput.classList.remove("is-invalid", "is-valid");

  if (!dobValue) {
    dobError.textContent = "Date of Birth is required.";
    dobInput.classList.add("is-invalid");
    return false;
  }

  const dob = new Date(dobValue);
  const today = new Date();
  let age = today.getFullYear() - dob.getFullYear();
  const monthDiff = today.getMonth() - dob.getMonth();
  const dayDiff = today.getDate() - dob.getDate();

  // Adjust for not yet reached birthday
  if (monthDiff < 0 || (monthDiff === 0 && dayDiff < 0)) {
    age--;
  }

  if (age < 26) {
    dobError.textContent = "Doctor must be at least 26 years old.";
    dobInput.classList.add("is-invalid");
    return false;
  }

  if (age > 75) {
    dobError.textContent = "Doctor's age cannot be more than 75 years.";
    dobInput.classList.add("is-invalid");
    return false;
  }

  dobInput.classList.add("is-valid");
  return true;
}

document.addEventListener("DOMContentLoaded", function() {
  const form = document.querySelector("form");
  const dobField = document.getElementById("dateOfBirth");

  // Prevent selecting future dates
  if (dobField) {
    const today = new Date().toISOString().split("T")[0];
    dobField.setAttribute("max", today);
    dobField.addEventListener("change", validateDOB);
  }

  if (form) {
    form.addEventListener("submit", function(e) {
      const validDOB = validateDOB();
      if (!validDOB) {
        e.preventDefault();
        dobField.focus();
      }
    });
  }
});
function validatePasswords() {
    const oldPass = document.getElementById("oldPassword");
    const newPass = document.getElementById("newPassword");
    const oldError = document.getElementById("oldError");
    const newError = document.getElementById("newError");

    const newPasswordPattern =
        /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

    let valid = true;

    // Reset states
    [oldPass, newPass].forEach(input => {
        input.classList.remove("is-invalid", "is-valid");
    });
    oldError.textContent = "";
    newError.textContent = "";

    // Old password validation
    if (oldPass.value.trim() === "") {
        oldError.textContent = "Old password is required.";
        oldPass.classList.add("is-invalid");
        valid = false;
    } else {
        oldPass.classList.add("is-valid");
    }

    // New password validation
    if (newPass.value.trim() === "") {
        newError.textContent = "New password is required.";
        newPass.classList.add("is-invalid");
        valid = false;
    } else if (!newPasswordPattern.test(newPass.value.trim())) {
        newError.textContent =
            "Password must be 8+ characters and include uppercase, lowercase, number, and special character.";
        newPass.classList.add("is-invalid");
        valid = false;
    } else {
        newPass.classList.add("is-valid");
    }

    return valid;
}

document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("form");
    const oldPass = document.getElementById("oldPassword");
    const newPass = document.getElementById("newPassword");

    // Live validation
    oldPass.addEventListener("input", validatePasswords);
    newPass.addEventListener("input", validatePasswords);

    form.addEventListener("submit", (e) => {
        if (!validatePasswords()) {
            e.preventDefault();
        }
    });
});
</script>

</head>
<body>
	<%@include file="navbar.jsp"%>

	<!-- Check if doctor is logged in -->
	<c:if test="${empty doctorObj }">
		<c:redirect url="../doctor_login.jsp"></c:redirect>
	</c:if>

	<div class="container p-4">
		<div class="row g-4">
			<!-- Column 1: Change Password -->
			<div class="col-md-5">
				<div class="card my-card h-100">
					<div class="card-body p-4">
						<h3 class="fs-3 text-center text-success">Change Password</h3>

						<!-- Password Messages -->
						<c:if test="${not empty successMsg }">
							<div class="alert alert-success text-center" role="alert">${successMsg}</div>
							<c:remove var="successMsg" scope="session" />
						</c:if>
						<c:if test="${not empty errorMsg }">
							<div class="alert alert-danger text-center" role="alert">${errorMsg}</div>
							<c:remove var="errorMsg" scope="session" />
						</c:if>

						<form action="../doctorChangePassword" method="post" class="mt-4">
							<div class="mb-3">
								<label class="form-label">Enter Old Password</label> <input
									 id="oldPassword" name="oldPassword" type="password"
									placeholder="Enter old password" class="form-control" required>
									 <div id="oldError" class="text-danger mt-1" style="font-size: 0.9em;"></div>
							</div>
							<div class="mb-3">
								<label class="form-label">Enter New Password</label> <input
									id="newPassword" name="newPassword" type="password"
									placeholder="Enter new password" class="form-control"
									required="required">
									 <div id="newError" class="text-danger mt-1" style="font-size: 0.9em;"></div>
							</div>
							<input type="hidden" value="${doctorObj.id}" name="doctorId">
							<button type="submit" class="btn btn-success w-100 mt-3">Change
								Password</button>
						</form>
					</div>
				</div>
			</div>

			<!-- Column 2: Edit Profile -->
			<div class="col-md-7">
				<div class="card my-card h-100">
					<div class="card-body p-4">
						<h3 class="fs-3 text-center text-success">Edit Doctor Profile</h3>

						<!-- Profile Messages -->
						<c:if test="${not empty successMsgForD }">
							<div class="alert alert-success text-center" role="alert">${successMsgForD}</div>
							<c:remove var="successMsgForD" scope="session" />
						</c:if>
						<c:if test="${not empty errorMsgForD }">
							<div class="alert alert-danger text-center" role="alert">${errorMsgForD}</div>
							<c:remove var="errorMsgForD" scope="session" />
						</c:if>

						<form action="../doctorEditProfile" method="post" class="mt-4">
							<div class="row g-3">
								<div class="col-md-12">
									<label class="form-label">Full Name</label> <input
										name="fullName" type="text" class="form-control"
										value="${doctorObj.fullName}" required
										pattern="^[A-Za-z\s]{2,40}$" maxlength="40"
										title="Full Name must be 2-40 letters and spaces only (no numbers or special characters)"
										oninput="this.value = this.value.replace(/[^A-Za-z ]/g, '')">
								</div>
								<div class="col-md-6">
									<label class="form-label">Date of Birth</label> <input
										id="dateOfBirth" name="dateOfBirth" type="date"
										class="form-control" value="${doctorObj.dateOfBirth}" required>
									<div id="dobError" class="text-danger mt-1"
										style="font-size: 0.9em;"></div>
								</div>
								<div class="col-md-6">
									<label class="form-label">Qualification</label> <input
										name="qualification" type="text" class="form-control"
										value="${doctorObj.qualification}">
								</div>
								<div class="col-md-6">
									<label class="form-label">Specialist</label> <select
										class="form-select" name="specialist" required>
										<option>${doctorObj.specialist}</option>
										<%
										SpecialistDAO spDAO = new SpecialistDAO(DBConnection.getConn());
										List<Specialist> spList = spDAO.getAllSpecialist();
										for (Specialist s : spList) {
										%>
										<option><%=s.getSpecialistName()%></option>
										<%
										}
										%>
									</select>
								</div>
								<div class="col-md-6">
									<label class="form-label">Phone</label> <input name="phone"
										type="tel" class="form-control" value="${doctorObj.phone}"
										required pattern="^\d{10}$" maxlength="10"
										title="Please enter a valid 10-digit mobile number"
										oninput="this.value = this.value.replace(/[^0-9]/g, '');">
								</div>
								<div class="col-md-12">
									<label class="form-label">Email address</label> <input
										name="email" type="email" class="form-control" readonly
										value="${doctorObj.email}">
								</div>

								<input type="hidden" value="${doctorObj.id}" name="doctorId">

								<div class="col-12 mt-3">
									<button type="submit" class="btn btn-success w-100">Update
										Profile</button>
								</div>
							</div>
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>
</html>